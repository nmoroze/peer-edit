{% extends "edit/base.html" %}

{% block customscripts %}
<script src="/static/js/bootbox.min.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		$("#point-input").on("change", function() {
		    var val = Math.abs(parseInt(this.value, 10) || 1);
		    this.value = val > {{ paper.points }} ? {{ paper.points }} : val;
		});

		var feedbackAdded = {{ feedback_list|length }} + 1;
		$.ajaxSetup({ 
		     beforeSend: function(xhr, settings) {
		         function getCookie(name) {
		             var cookieValue = null;
		             if (document.cookie && document.cookie != '') {
		                 var cookies = document.cookie.split(';');
		                 for (var i = 0; i < cookies.length; i++) {
		                     var cookie = jQuery.trim(cookies[i]);
		                     // Does this cookie string begin with the name we want?
		                 if (cookie.substring(0, name.length + 1) == (name + '=')) {
		                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                     break;
		                 }
		             }
		         }
		         return cookieValue;
		         }
		         if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
		             // Only send the token to relative URLs i.e. locally.
		             xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
		         }
		     } 
		});
		{% if ownPaper %}
		{% else %}
		$("#paper-body").on("mouseup", function(e){
			if(highlight()){
				bootbox.prompt("Feedback:", function(result) {
					$.post("/api/save/{{ paper.id }}/", { data: $("#paper-body").html(),
														  content: result,
														  author: {{author.id}} });
				});
			}
		});
		{% endif %}

		function highlight() {
		    var selection = window.getSelection().getRangeAt(0);
		    var selectedText = selection.extractContents();
		    var snippetLength = selectedText.textContent.length;
		    if(snippetLength>0&&snippetLength<300) {
			    var span = $("<span class='highlight'>" + selectedText.textContent + "</span>");
			    var note = $("<sup id='note"+feedbackAdded+"'><a href='#"+feedbackAdded+"'>"+feedbackAdded+"</a></sup>");
			    feedbackAdded++;
			    selection.insertNode(span[0]);
			    selection.collapse(false);
			    selection.insertNode(note[0]);
			   
			    // if (selectedText.childNodes[1] != undefined){
			    //     console.log(selectedText.childNodes[1]);
			    //     $(selectedText.childNodes[1]).remove();
			    // }
			    
			    var txt = $('#paper-body').html();

			    $('#paper-body').html(txt.replace(/<\/span>(?:\s)*<span class="highlight">/g, ''));
			     clearSelection();
			     return true;
			 }
			 else {
			 	selection.insertNode(selectedText);
			 	return false;
			 }
		}	

		function clearSelection() {
		    if ( document.selection ) {
		        document.selection.empty();
		    } else if ( window.getSelection ) {
		        window.getSelection().removeAllRanges();
		    }
		}
	});
</script>
{% endblock %}

{% block content %}
<h1> {{ paper.question }} </h1>

<p id="paper-body"> {{ paper.body|safe }} </p>

<ul>
{% for feedback in feedback_list %}
	{% if feedback.chosen %}
	{% else %}
	<li id="{{ forloop.counter }}"> <a href="#note{{ forloop.counter }}">({{ forloop.counter }})</a> {{ feedback.content }} {% if paper.points != 0 and ownPaper %}<form method="post" action="/bestfeedback/{{ feedback.id }}/" style="float: right;">{% csrf_token %}<a href="#" onClick="$(this).parent().submit(); return false;">Give points </a><input id="point-input" class="feedback" type="number" name="points" min="1" max={{ paper.points }} required="required"></form>{% endif %}<br> - {{ feedback.author.user.username }} </li>
	{% endif %}
{% endfor %}
</ul>

{% endblock %}

